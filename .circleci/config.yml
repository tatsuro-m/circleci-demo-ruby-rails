version: 2
jobs:
  build:
    parallelism: 3
    docker:
      - image: circleci/ruby:2.4.2-jessie-node
        environment:
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
          BUNDLE_PATH: vendor/bundle
          PGHOST: 127.0.0.1
          PGUSER: circleci-demo-ruby
          RAILS_ENV: test
      - image: circleci/postgres:9.5-alpine
        environment:
          POSTGRES_USER: circleci-demo-ruby
          POSTGRES_DB: rails_blog
          POSTGRES_PASSWORD: ""
        steps:
          - checkout

          - run:
              name: which_bundler
              command: bundle -v

          - restore_cache:
              keys:
                - rails-demo-bundle-v2-{{checksum "Gemfile.lock"}}
                - rails-demo-bundle-v2-
          - run:
            name: Bundle Install
            command: bundle check || bundle install
          - save_cache:
              key: rails-demo-bundle-v2-{{ checksum "Gemfile.lock"}}
              paths:
                - vendor/budle

          - restore_cache:
              keys:
                - rails-demo-yarn-{{checksum "yarn.lock"}}
                - rails-demo-yarn-

          - run:
              name: Yarnをインストールします
              command: yarn install --cache-folder ~/.cache/yarn

          - save_cache:
              key: rails-demo-yarn-{{checksum "yarn.lock"}}
              paths:
                - ~/.cache/yarn

          - run:
              name: DBを待機
              command: dockerize-wait tcp://localhost:5432 -timeout 1m

          - run:
              name: データベースをセットアップ
              command: bin/rails db:schema:load --trace

          - run:
              name: RSpecを並列実行
              command: |
                bundle exec rspec --profile 10\
                --format RspecJunitFormatter\
                --out test_results/rspec.xml\
                --format progress\
                $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split-by=timings

          # テスト結果を保存します

        - store_test_results:
            path: test_results